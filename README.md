<h1 align="center">üïµÔ∏è‚Äç‚ôÄÔ∏è INCIDENT RESPONSE REPORT</h1>
<h1 align="center">ESCALATION OF PRIVILEGES & DATA EXFILTRATION</h1>

<p align="center">
  <img width="500" src="https://github.com/user-attachments/assets/a0adf9a5-0da7-4f59-a5d6-6615358b3f41" alt="Linux" />
</p>


## üõ†Ô∏è TECHNOLOGY & TOOLS UTILIZED

- **`Microsoft Azure:`**  
  Linux virtual machines were hosted on Azure, with Azure Storage and Containers employed to support deployment and facilitate the simulated data exfiltration.

- **`Microsoft Defender for Endpoint:`**  
  Used as the primary Endpoint Detection & Response (EDR) solution to monitor and protect the environment.

- **`Kusto Query Language (KQL):`**  
  Used for querying and analyzing security telemetry across Azure and Defender environments.

- **`Microsoft Sentinel:`**  
  Used to create and manage detection rules.  

---

## [SCENARIO CREATION](https://github.com/brianalwillis/threat-hunting-scenario-tor/blob/main/scenario-creation)

##  SCENARIO OVERVIEW

Company A suspects that sensitive employee Personally Identifiable Information (PII) ‚Äî including addresses, email addresses, and phone numbers ‚Äî is being leaked due to recent phishing attacks. This PII is stored securely on a Linux server in a hidden file accessible only by root or sudo users. Recently, an employee reported suspicious behavior involving unauthorized access to the server while the root administrator was away. To investigate, the company simulates a scenario where an attacker with root privileges inserts a malicious script that escalates privileges by granting sudo access to a specific user, steals PII data, and then deletes itself to avoid detection. This simulation helps understand how attackers create backdoors and exfiltrate data.

## OBJECTIVE

This lab aims to teach participants how to detect and respond to unauthorized privilege escalation and data exfiltration on a Linux server. Through hands-on exercises, users will learn basic Linux commands, analyze logs generated by Microsoft Defender for Endpoint (MDE), and conduct an incident response investigation following the `NIST 800-61` guidelines. Participants will gain practical experience identifying malicious activity, understanding attacker tactics, and compiling an incident report.

---

## HIGH-LEVEL IOC DISCOVERY PLAN

### File Activity Analysis ‚Äî `DeviceFileEvents`

- To identify suspicious or unauthorized file creations that may indicate malware deployment or script placement.
- To track modifications or duplication of critical files tied to attacker activity.
- To find privilege escalation attempts linked to file changes or creation of backdoor scripts.

### Process Activity Monitoring ‚Äî `DeviceProcessEvents`

- To detect execution of malicious scripts or binaries on the system.
- To monitor commands and process trees that reveal attacker techniques or privilege escalation.
- To correlate process activity with file events and network communications for a full attack timeline.

### Network Traffic Analysis ‚Äî `DeviceNetworkEvents`

- To validate data exfiltration by identifying outbound connections to suspicious or external endpoints.
- To monitor network traffic patterns that may indicate command-and-control or tunneling activity.
- To confirm successful transfers to cloud storage or attacker-controlled infrastructure.

---

## STEPS TAKEN

### Step 1: Initial File Detection

To investigate potential attacker activity, we can start by querying the `DeviceFileEvents` table to identify any file creations that occurred during the suspected timeframe, specifically around the day of the simulated attack. This is when the attacker would have placed the malicious script on the virtual machine.

**Query:**
```kql
DeviceFileEvents
| where DeviceName contains "willis-linux-mde"
| where ActionType == "FileCreated"
| order by Timestamp desc
```

**Results:**

![Linux 1](https://github.com/user-attachments/assets/9b7cc504-78dd-4c00-900f-eaca22b5d0a8)

Upon reviewing the results of the `DeviceFileEvents` query, a suspicious file named `super_secret_script.sh` was identified. It was created on `2025-07-08T20:32:03.908779Z`. Notably, there are two entries in the dataset referencing this filename. After analyzing both instances, we observed key differences in their file paths, creation metadata, or associated processes, which may indicate modifications or duplicate deployment attempts by the attacker. 

---

### Step 2: Analyzing the Malicious Script

**Query:**
```kql
DeviceFileEvents
| where DeviceName contains "willis-linux-mde"
| where ActionType == "FileCreated"
| where FileName contains "secret"
| order by Timestamp desc
| project Timestamp, DeviceName, ActionType, FileName, InitiatingProcessCommandLine
```

**Results:**

![Linux 2](https://github.com/user-attachments/assets/b98c26ee-5cc6-42fe-813c-6d697866f9ed)


In this scenario, the attacker used the `touch` command to create the file `super_secret_script.sh`, followed by the `nano` command to open and likely edit it using the `Nano text editor`. This sequence suggests that the script was created and modified locally on the system, indicating hands-on activity rather than remote deployment.

This is the first key indicator of suspicious behavior. To continue the investigation, we‚Äôll now examine the `DeviceFileEvents` table further to identify any additional unusual or related file activity that may provide deeper insight into the attacker's methods or objectives.

---

### Step 3: Investigating Privilege Escalation

At this stage, I'm refining my query to isolate and display only the most relevant details about the suspicious TOR-related activity. I'm focusing on events that occurred after the specific timestamp when the suspicious activity began: `2025-07-05T00:58:17.8896593Z`.

**Query:**
```kql
DeviceFileEvents
| where DeviceName contains "willis-linux-mde"
| where ActionType == "FileCreated"
| project Timestamp, DeviceName, FileName, InitiatingProcessCommandLine, InitiatingProcessParentFileName
| order by Timestamp desc
```

**Results:**

![Linux 3](https://github.com/user-attachments/assets/049a4786-0492-4d2e-a206-e71e298aab68)

The `InitialProcessCommandLine` field provides valuable context into what actions were performed on the system. After the command `nano super_secret_script.sh`, which was likely used to write or modify the malicious script, another notable entry appears: `usermod -aG sudo badactor`.

This command is highly suspicious, as it adds the user `badactor` to the `sudo` group, effectively granting elevated privileges. This action creates a backdoor for persistent administrative access, enabling the attacker to return and interact with the system at a root level without re-exploiting vulnerabilities.

The pattern is becoming clear: the attacker created a script, edited it, and used it to escalate privileges‚Äîall while attempting to remain under the radar. The investigation is closing in on how the breach occurred and what systems may have been affected.

---

### Step 4: Search for Script Execution

To track potential execution of the malicious script, we queried the `DeviceProcessEvents` table using a filtered timestamp at `2025-07-08T20:55:51.372756Z`, set just after the creation of `super_secret_script.sh` ‚Äî to capture relevant activity in the immediate aftermath. This approach allows us to focus on the sequence of processes initiated right after the suspicious script was created. By sorting the results in ascending order, we can observe any execution commands, privilege escalation attempts, or other anomalous behavior tied to attacker activity.

**Query:**
```kql
DeviceProcessEvents
| where Timestamp >= datetime(2025-07-08T20:55:51.372756Z)
| where DeviceName contains "willis-linux-mde"
| project Timestamp, DeviceName, ActionType, InitiatingProcessCommandLine
| order by Timestamp asc
```

**Results:**

![Linux 4](https://github.com/user-attachments/assets/5b88a1f5-a6e5-4c75-b2eb-0ebaa0f09b05)

From the logs in `DeviceProcessEvents`, we observe a key entry at `2025-07-08T20:55:51.372756Z`, where the `InitiatingProcessCommandLine` value is: `/bin/bash ./super_secret_script.sh`.

This confirms that the attacker executed the malicious script using the Bash interpreter. The `./super_secret_script.sh` portion indicates that the script was run from the local directory, validating our earlier assumption that the attacker directly interacted with the system.

Immediately following this event, we see a sequence of commands consistent with suspicious `Azure CLI` activity. Notably, at `2025-07-08T20:55:51.483628Z`, a command is logged that initiates an upload to an `Azure Storage Blob`, using both an account key and a storage account‚Äîa clear sign of data exfiltration targeting the previously accessed PII.

An attempt was also made to identify whether the script deleted itself post-execution, as a forensic audit of the VM found no trace of the script or its contents. However, no explicit deletion command was found in the `DeviceProcessEvents` or `DeviceFileEvents` tables. It‚Äôs possible the script used a method to remove itself silently or employed a different mechanism not captured in these data sources.

---

### Step 5: Verify Network Activity

To validate the data exfiltration behavior observed earlier, we performed a quick review of the `DeviceNetworkEvents` table using the following query:

**Query:**
```kql
DeviceNetworkEvents
| where Timestamp >= datetime(2025-07-08T20:55:51.372756Z)
| where DeviceName contains "willis-linux-mde"
| project Timestamp, ActionType, InitiatingProcessCommandLine
| order by Timestamp asc
```

**Results:**

![Linux 5](https://github.com/user-attachments/assets/61b6532b-eaec-4fb0-ac9e-5b12c3afedca)

This query filters events to those occurring after the suspected script execution and orders them chronologically. Among the results, we observed a `ConnectionRequest` event involving the `Azure CLI` and targeting `Azure Blob Storage`, followed shortly by a `ConnectionSuccess` event for the same operation. This confirms that the exfiltration attempt reached its destination and was successful, further validating the presence of unauthorized data transfer from the VM to an external cloud resource.

---

## CHRONOLOGICAL EVENT TIMELINE

### Step 1 ‚Äì Initial File Detection
- **Timestamp:** `2025-07-08T20:32:03.908779Z`  
- **Event:** Suspicious File Creation  
- **Action:** `super_secret_script.sh` was created on the VM  
- **File Path** `/home/bwillis/super_secret_script.sh` 

### Step 2 ‚Äì Analyzing the Malicious Script
- **Timestamp:** `2025-07-08T20:32:03.908779Z`  
- **Event:** Malicious Script Creation and Modification  
- **Action:** `touch super_secret_script.sh` followed by `nano super_secret_script.sh`  
- **File Path** `/bin/bash ./super_secret_script.sh`  

### Step 3 ‚Äì Investigating Privilege Escalation
- **Timestamp:** `2025-07-08T20:55:51.469559Z` 
- **Event:** Escalation of user privileges  
- **Action:** `usermod -aG sudo badactor` executed to add user to sudo group  
- **File Path** N/A  

### Step 4 ‚Äì Search for Script Execution
- **Timestamp:** `2025-07-08T20:55:51.372756Z`  
- **Event:** Execution of malicious script and data exfiltration begins  
- **Action:** `/bin/bash ./super_secret_script.sh` runs script; Azure CLI uploads data to blob storage  
- **File Path** `/home/bwillis/.secret_data/.my_secret_file.txt --name test_file`  

### Step 5 ‚Äì Verifying Network Activity
- **Timestamp:** `2025-07-08T20:55:52.847203Z`  
- **Event:** Network Connection Established  
- **Action:** `ConnectionRequest` and `ConnectionSuccess` events to Azure Blob Storage  
- **File Path** N/A 

---

## SUMMARY

An internal user appears to have gained unauthorized root access to a `Linux` server and executed a malicious script. The script performed two primary functions. First, it accessed a hidden file containing sensitive Personally Identifiable Information (PII) ‚Äî previously accessible only to sudo-level accounts ‚Äî and exfiltrated this data to an external `Azure storage` location.

Second, the script escalated the user‚Äôs privileges by granting their account sudo access, effectively creating a persistent backdoor for future unauthorized access. After completing its tasks, the script self-deleted in an apparent attempt to avoid detection.

---

## RESPONSE TAKEN

In response to this incident, the affected user account was temporarily suspended pending further investigation and guidance from management. As a precautionary measure, the account‚Äôs sudo privileges were also revoked to prevent any additional unauthorized activity. A summary of the findings and actions taken was submitted to the employee‚Äôs manager and executive leadership for review and further direction.

---

*This project investigates a simulated attack on a Linux VM in Microsoft Azure, focusing on detecting privilege escalation and data exfiltration using telemetry from Microsoft Defender for Endpoint and Microsoft Sentinel. It demonstrates how to analyze file, process, and network events to uncover and respond to malicious activity.*

**Created By:** `Briana Willis`  
**Date:** `2025-07-09`  
**Time:** `22:34 UTC`

